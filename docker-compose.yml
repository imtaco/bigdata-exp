version: '3.8'

services:
  # MinIO - S3-compatible
  # run following commands for init:
  # mc alias set myminio http://minio:9000 admin password;
  # mc mb myminio/warehouse || true;
  # mc mb myminio/data || true;
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: minio
    ports:
      - "9000:9000"      # API
      - "9001:9001"      # Console
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trino-network

  # PostgreSQL - Iceberg Catalog & Supserset Meta
  pg1616:
    image: postgres:16
    container_name: pg1616
    environment:
      POSTGRES_USER: iceberg
      POSTGRES_PASSWORD: iceberg
      POSTGRES_DB: iceberg_catalog
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iceberg"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trino-network

  # Trino Coordinator
  # Tri (three) + no-SQL / no-Hadoop / no...
  trino:
    image: trinodb/trino:478
    container_name: trino
    depends_on:
      pg1616:
        condition: service_healthy
      minio:
        condition: service_healthy
    ports:
      - "8080:8080"
    volumes:
      - ./trino/catalog:/etc/trino/catalog
      - ./trino/config.properties:/etc/trino/config.properties
      - ./trino/core-site.xml:/etc/trino/core-site.xml
      - ./trino/password-authenticator.properties:/etc/trino/password-authenticator.properties
      - ./trino/password.db:/etc/trino/password.db
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - S3_ENDPOINT=http://minio:9000
      - S3_PATH_STYLE_ACCESS=true
    networks:
      - trino-network

  # Trino Worker 1
  trino-worker-1:
    image: trinodb/trino:478
    container_name: trino-worker-1
    depends_on:
      - trino
    volumes:
      - ./trino/catalog:/etc/trino/catalog
      - ./trino/worker-config.properties:/etc/trino/config.properties
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - S3_ENDPOINT=http://minio:9000
      - S3_PATH_STYLE_ACCESS=true
    networks:
      - trino-network

  # Nginx proxy - test with delay
  trino-proxy:
    image: openresty/openresty:1.27.1.2-alpine-fat
    container_name: trino-proxy
    depends_on:
      - trino
    ports:
      - "8081:8081"
    volumes:
      - ./nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
    networks:
      - trino-network

  # Redis - Superset broker & cache
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - trino-network

  # Apache Superset
  superset:
    image: superset-trino:latest
    container_name: superset
    depends_on:
      - pg1616
      - redis
    ports:
      - "8088:8088"
    # command: "tail -f /dev/null"
    # https://github.com/apache/superset/blob/465e2a9631994892cf399d13dd926c56cecd58ca/docker/.env
    environment:
      - SUPERSET_CONFIG_PATH=/app/pythonpath/superset_config.py
      - SUPERSET_DATABASE_URI=postgresql+psycopg2://iceberg:iceberg@pg1616:5432/superset
      - SUPERSET_SECRET_KEY=superset-secret-key-change-in-production
      - GLOBAL_ASYNC_QUERIES_JWT_SECRET=your-secret-key-at-least-32-bytes-long-change-in-production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./pythonpath:/app/pythonpath
    networks:
      - trino-network

  superset-worker:
    image: superset-trino:latest
    container_name: superset-worker
    depends_on:
      - superset
      - redis
    environment:
      - SUPERSET_CONFIG_PATH=/app/pythonpath/superset_worker_config.py
      - SUPERSET_SECRET_KEY=superset-secret-key-change-in-production
      - SUPERSET_DATABASE_URI=postgresql+psycopg2://iceberg:iceberg@pg1616:5432/superset
      - GLOBAL_ASYNC_QUERIES_JWT_SECRET=your-secret-key-at-least-32-bytes-long-change-in-production
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SUPERSET_WEBSERVER_PROTOCOL=http
      - SUPERSET_WEBSERVER_ADDRESS=localhost
      - SUPERSET_WEBSERVER_PORT=8088
      - CELERYD_CONCURRENCY=4
    # command: tail -f /dev/null
    # https://github.com/apache/superset/blob/465e2a9631994892cf399d13dd926c56cecd58ca/docker/docker-bootstrap.sh
    command: "celery --app=superset.tasks.celery_app.app worker -O fair --loglevel=INFO"
    volumes:
      - ./pythonpath:/app/pythonpath
    networks:
      - trino-network

  superset-beat:
    image: superset-trino:latest
    container_name: superset-beat
    depends_on:
      - superset
      - redis
    environment:
      - SUPERSET_CONFIG_PATH=/app/pythonpath/superset_worker_config.py
      - SUPERSET_SECRET_KEY=superset-secret-key-change-in-production
      - SUPERSET_DATABASE_URI=postgresql+psycopg2://iceberg:iceberg@pg1616:5432/superset
      - GLOBAL_ASYNC_QUERIES_JWT_SECRET=your-secret-key-at-least-32-bytes-long-change-in-production
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SUPERSET_WEBSERVER_PROTOCOL=http
      - SUPERSET_WEBSERVER_ADDRESS=localhost
      - SUPERSET_WEBSERVER_PORT=8088
      # CPU count
      - CELERYD_CONCURRENCY=4
    # command: "tail -f /dev/null"
    command: "celery --app=superset.tasks.celery_app beat -l INFO --schedule=/tmp/celerybeat-schedule"
    volumes:
      - ./pythonpath:/app/pythonpath
    networks:
      - trino-network

  # for testing alert
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: mailhog
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI
    networks:
      - trino-network

volumes:
  minio-data:
  postgres-data:
  redis-data:

networks:
  trino-network:
    driver: bridge
